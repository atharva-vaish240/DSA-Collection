name: ğŸ† Update Contributors

on:
  push:
    branches: [main]
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    # Only run on push to main or when PR is merged (not just closed)
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true)

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸ† Update contributors list
      run: |
        CONTRIBUTORS=$(curl -s "https://api.github.com/repos/${{ github.repository }}/contributors?per_page=100" | jq -r '.[] | select(.type != "Bot") | @base64 "\(.login), \(.avatar_url), \(.contributions)"')
        
        {
          echo "<div align=\"center\">";
          echo "  <a href=\"https://github.com/admirerr/DSA-Collection/graphs/contributors\">";
          
          for c in $CONTRIBUTORS; do
            DECODED=$(echo "$c" | base64 -d)
            IFS=',' read -r login avatar_url contributions <<< "$DECODED"
            echo "    <img src=\"${avatar_url}&s=50\" width=\"50\" height=\"50\" alt=\" ${login}\" />";
          done
          
          echo "  </a>";
          echo "</div>";
        } > contributors.html

        python << EOF
        import re

        with open('README.md', 'r+') as f:
            text = f.read()
            with open('contributors.html', 'r') as c:
                contributors_html = c.read()
            
            # Replace everything between the tags
            new_text = re.sub(r'(<!-- CONTRIBUTORS_LIST -->)(.|\n)*(<!-- CONTRIBUTORS_LIST_END -->)',
                              f'\1\n{contributors_html}\n\3',
                              text)
            
            f.seek(0)
            f.write(new_text)
            f.truncate()
        EOF

    - name: ğŸ“ˆ Update language statistics
      run: |
        echo "ğŸ“ˆ Updating language statistics...";

        # Count files by language
        cpp_files=$(find CPP/ -name "*.cpp" 2>/dev/null | wc -l || echo 0)
        java_files=$(find Java/ -name "*.java" 2>/dev/null | wc -l || echo 0)
        python_files=$(find Python/ -name "*.py" 2>/dev/null | wc -l || echo 0)

        total_implementations=$((cpp_files + java_files + python_files))

        echo "ğŸ“Š Language Statistics:";
        echo "C++: $cpp_files files";
        echo "Java: $java_files files";
        echo "Python: $python_files files";
        echo "Total: $total_implementations implementations";

        # Count supported languages
        supported_languages=3 # Base languages: C++, Java, Python

        echo "Supported languages: $supported_languages";

        # Update README stats
        if [ -f "README.md" ]; then
          sed -i "s/ğŸ’» \*\*[0-9]*+ Languages\*\*/ğŸ’» **${supported_languages}+ Languages**/g" README.md
        fi

    - name: ğŸ“… Update last modified date
      run: |
        echo "ğŸ“… Updating last modified date...";
        current_date=$(date +"%B %Y")

        if [ -f "HALL_OF_FAME.md" ]; then
          sed -i "s/\*Last updated: .* [0-9]*\*/\*Last updated: $current_date\*/g" HALL_OF_FAME.md
          echo "âœ… Updated last modified date in HALL_OF_FAME.md";
        fi

    - name: ğŸ” Check for changes
      id: changes
      run: |
        if git diff --quiet; then
          echo "No changes to commit";
          echo "has_changes=false" >> $GITHUB_OUTPUT;
        else
          echo "Changes detected";
          echo "has_changes=true" >> $GITHUB_OUTPUT;
          echo "Changed files:";
          git diff --name-only;
        fi

    - name: ğŸ’¾ Commit and push changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com";
        git config --local user.name "GitHub Action";

        git add README.md HALL_OF_FAME.md;

        git commit -m "ğŸ† Auto-update contributor statistics";

        git push;

    - name: ğŸ“‹ Generate summary
      run: |
        echo "ğŸ† Contributors Update Summary";
        echo "==============================";
        echo "";
        echo "ğŸ“Š Statistics:";
        echo "  ğŸ‘¥ Total Contributors: ${{ steps.contributors.outputs.total_contributors }}";
        echo "  ğŸ”¥ Repository Status: Active";
        echo "  ğŸ“… Last Updated: $(date)";
        echo "";
        echo "ğŸ‰ Contributor statistics updated successfully!";

        if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
          echo "âœ… Changes committed and pushed";
        else
          echo "â„¹ï¸ No changes needed";
        fi